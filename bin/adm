#!/usr/bin/env bash
##  adm - lightweight sysadmin tool for compute server
##
##  Usage:
##    adm group command [options]
##
##  Options:
##    -h, --help       Show this help message and exit
##

#------------------------------ CONFIGURATION ----------------------------------
set -euo pipefail

# Check for sudo privileges (remove if not required)
if [ "$(id -u)" -ne 0 ]; then
    echo "[ERROR] This script must be run with sudo or as root." >&2
    exit 1
fi

ADM_NAME="${ADM_NAME:-adm}"
ADM_LIB_DIR="${ADM_LIB_DIR:-/usr/local/lib/adm}"

#------------------------------ FUNCTIONS --------------------------------------


# Lists all available commands
list_commands() {
  ( cd "$ADM_LIB_DIR" 2>/dev/null || exit 0
      for rel in */*.sh; do
        [ -f "$rel" ] || continue
        grp="${rel%%/*}"
        cmd="$(basename "${rel%.sh}")"
        desc="$(awk '/^##/{sub(/^##[ ]?/,""); print; exit}' "$ADM_LIB_DIR/$rel" 2>/dev/null)"
        printf "  adm %s %s - %s\n" "$grp" "$cmd" "${desc}"
      done
  )
}

# Print help message (only lines starting with ##)
show_help() {
    grep '^##' "$0" | sed 's/^##[ ]\{0,1\}//'
    echo " Available commands:"
    list_commands
}

print_version() {
  cat ${ADM_LIB_DIR}/self/VERSION
}


# Resolve to an executable script path, allowing hyphen/underscore aliases
resolve_script_path() {
  local group="$1" cmd="$2"
  if [[ -f "${ADM_LIB_DIR}/${group}/${cmd}.sh" ]]; then
    echo "${ADM_LIB_DIR}/${group}/${cmd}.sh"
    return 0
  fi
  echo "Command not found: ${group} ${cmd}" >&2
  echo " Available commands:"
  list_commands
  return 1
}

dispatch() {
  local group="$1"; shift
  local cmd="$1"; shift

  local script
  script="$(resolve_script_path "${group}" "${cmd}")"

  if [[ ! -x "${script}" ]]; then
    # If present but not executable, try to execute via bash
    if [[ -f "${script}" ]]; then
      exec bash "${script}" "$@"
    else
      echo "No such command script: ${script}" >&2
      exit 127
    fi
  else
    exec "${script}" "$@"
  fi
}

main() {
  # No args -> usage + list
  if [[ $# -eq 0 ]]; then
    show_help
    exit 1
  fi

  case "${1:-}" in
    -h|--help)
      show_help
      exit 0
      ;;
    -v|--version)
      print_version
      exit 0
      ;;
  esac

  # Expect at least <group> <command>
  if [[ $# -lt 2 ]]; then
    echo "Error: missing <group> <command>" >&2
    echo
    show_help
    exit 2
  fi

  local group="$1"; shift
  local cmd="$1"; shift

  dispatch "${group}" "${cmd}" "$@"
}

main "$@"
